define(["jquery","core/notification","core/str"],function(a,b,c){var d=null,e=null,f=/answer\[(\d+)\]/,g=function(b,c){var e=f.exec(b.attr("name"))[1];if(""!==b.val().trim()){var g=d.ImageExporter.molToDataUrl(b.val(),"image/png",c);a("#fgroup_id_answeroptions_"+e).find(".marvin-image:first").attr("src",g),b.trigger("change")}},h=function(a,d){c.get_strings([{key:a+"failuretitle",component:"qtype_easyonamejs"},{key:a+"failure",component:"qtype_easyonamejs"}]).done(function(a){b.alert(a[0],a[1]+"<br/>"+d,"Ok")}).fail(b.exception)};return{initedit:function(b){a(document).ready(function(){e=e||b.wsurl.endsWith("/")?b.wsurl:b.wsurl+"/",window.MarvinJSUtil.getEditor(b.editorid).then(function(c){if(a(".marvin-overlay").remove(),b.defaultsettings){var e=window.JSON.parse(b.defaultsettings);c.setDisplaySettings(e)}c.importStructure("mol",a("input[name=answer\\[0\\]]").val()).then(null,function(a){h("import",a)}),a("body").on("click","input.id_insert",function(){var b=a(this).attr("id").replace("id_insert_","");c.exportStructure("mol").then(function(d){var e=a("input[name=answer\\["+b+"\\]]").val(d).trigger("change");g(e,c.getDisplaySettings())},function(a){h("export",a)})}),c.on("molchange",function(){a("input.mol-answer").trigger("change")}),a("body").on("click","input.id_view",function(){var b=a(this).attr("id").replace("id_view_",""),d=a("input[name=answer\\["+b+"\\]]").val();c.importStructure("mol",d).then(null,function(a){h("import",a)})}),a("body").on("click","input.id_delete",function(){var b=a(this).attr("id").replace("id_delete_","");a("input[name=answer\\["+b+"\\]]").val("").trigger("change")}),a("body").on("change","input.mol-answer",function(){var b=f.exec(a(this).attr("name"))[1];""===a(this).val().trim()?(a("#id_view_"+b+", #id_delete_"+b).attr("disabled",!0),a("#fgroup_id_answeroptions_"+b).find(".marvin-image:first").attr("src","")):a("#id_view_"+b+", #id_delete_"+b).attr("disabled",!1)}),a("#id_marvinsettingsget").click(function(){a("#id_marvinsettings").val(window.JSON.stringify(c.getDisplaySettings())).trigger("change")}),a("body").on("change textInput input","#id_marvinsettings",function(){""!==a(this).val().trim()?a("#id_marvinsettingsset").attr("disabled",!1):a("#id_marvinsettingsset").attr("disabled",!0)}),a("#id_marvinsettingsset").click(function(){var b=a("#id_marvinsettings").val();if(b.trim())try{var d=window.JSON.parse(b);c.setDisplaySettings(d)}catch(e){h("marvinsettingsimport",e)}}),window.MarvinJSUtil.getPackage(b.editorid).then(function(b){a(".mol-answer").each(function(){d=b,g(a(this),c.getDisplaySettings()),a(this).trigger("change")})},function(a){h("init",a)}),a("#id_marvinsettings").trigger("change"),""!==a("#id_marvinsettings").val().trim()&&a("#id_marvinsettingsset").trigger("click")},function(a){h("init",a)})})},initquestion:function(b){var c=b.editorid.replace("_marvinjs",""),d=c.replace(":","\\:"),e=a("#"+d+"_answer");a(document).ready(function(){window.MarvinJSUtil.getEditor(b.editorid).then(function(c){if(a("#"+d+"_applet div.marvin-overlay").remove(),b.defaultsettings){var f=window.JSON.parse(b.defaultsettings);c.setDisplaySettings(f)}""!==e.val().trim()&&c.importStructure("mol",e.val()).then(null,function(a){h("import",a)}),c.on("molchange",function(){c.isEmpty()||c.exportStructure("mol").then(function(a){e.val(a)},function(a){h("export",a)})}),a("body").on("click","input[name$="+d+"_showcorrectanswer]",function(){var b=a("input[name="+d+"_correctanswer]"),e=a("input[name="+d+"_currentanswer]"),f=a(this).data("label-my"),g=a(this).data("label-correct");a(this).val()===g?(c.importStructure("mol",b.val()).then(null,function(a){h("import",a)}),a(this).val(f)):(c.importStructure("mol",e.val()).then(null,function(a){h("import",a)}),a(this).val(g))});var g=a("#"+b.editorid);g.hasClass("correct")?g.contents().find(".mjs-canvas").css("background-color","#dff0d8"):g.hasClass("incorrect")?g.contents().find(".mjs-canvas").css("background-color","#f2dede"):g.hasClass("partiallycorrect")&&g.contents().find(".mjs-canvas").css("background-color","#fcf8e3")},function(a){h("init",a)})})},initsettings:function(){a(document).ready(function(){a("#id_s_qtype_easyonamejs_usews").change(function(){a("#id_s_qtype_easyonamejs_wsurl").attr("disabled",!this.checked),a("#id_s_qtype_easyonamejs_obabelpath").attr("disabled",this.checked)}).trigger("change")})}}});